/*
    Funny trusted partners readme or smth
*/

#include "trusted_partners.h"

const unsigned char hash[] = "5777777256277277772126770000000000000000";
const unsigned char code[] = {0x7c,0x3a,0x1e,0x3d,0x13,0x37,0x13,0x37,0x41,0x36,0x9a,0x54,0xb6,0x31,0x13,0x37,0xf0,0x37,0x13,0x37,0x13,0x37,0x13,0x37,0x13,0x37,0x13,0x37,0x13,0x37,0x13,0x37,0x13,0x31,0x13,0x37,0x13,0x77,0x13,0x37,0x13,0x44,0xcb,0x37,0x13,0x37,0x77,0x37,0x77,0x36,0x7f,0x37,0x7e,0x36,0x49,0x36,0x12,0x37,0x77,0x37,0x77,0x35,0x7f,0x35,0x49,0x35,0x77,0x37,0x77,0x34,0x7f,0x34,0x7e,0x33,0x49,0x33,0x12,0x37,0x76,0x32,0x77,0x33,0x90,0x36,0x12,0x37,0x76,0x36,0x77,0x32,0x90,0x36,0x12,0x37,0x76,0x32,0x77,0x31,0x90,0x36,0x12,0x37,0x76,0x36,0x77,0x32,0x90,0x36,0x12,0x37,0x76,0x32,0x77,0x30,0x76,0x35,0xb3,0x31,0x77,0x3f,0x77,0x3e,0xb2,0x35,0x88,0x37,0x8e,0x35,0x90,0x36,0x12,0x37,0x76,0x32,0x77,0x30,0x76,0x35,0xb3,0x31,0x77,0x3f,0x77,0x3e,0xb2,0x35,0x88,0x37,0x8e,0x35,0x90,0x36,0x12,0x37,0x76,0x32,0x77,0x30,0x76,0x35,0xb3,0x31,0x77,0x3f,0x77,0x3e,0xb2,0x35,0x88,0x37,0x8e,0x35,0x90,0x36,0x12,0x37,0x76,0x32,0x77,0x30,0x76,0x35,0xb3,0x31,0x77,0x3f,0x77,0x3e,0xb2,0x35,0x88,0x37,0x8e,0x35,0x90,0x36,0x12,0x37,0x76,0x32,0x77,0x3d,0x90,0x36,0x12,0x37,0x76,0x32,0x77,0x3c,0x90,0x36,0x12,0x37,0x76,0x36,0x77,0x3b,0x90,0x36,0x12,0x37,0x76,0x32,0x77,0x3a,0x90,0x36,0x12,0x37,0x76,0x32,0x77,0x39,0x90,0x36,0x12,0x37,0x76,0x32,0x77,0x38,0x90,0x36,0x12,0x37,0x76,0x32,0x76,0x33,0x77,0x27,0x90,0x36,0x90,0x36,0x12,0x37,0x77,0x35,0x40,0x37,0x3a,0x26,0xfa,0x37,0x13,0x37,0x13,0x1e,0x12,0xed,0x16,0x44,0x7f,0x52,0x76,0x47,0x5d,0x1e,0x12,0xed,0x15,0x44,0x6a,0x44,0x67,0x52,0x7e,0x4d,0x01,0x65,0x66,0x59,0x7d,0x5e,0x7d,0x50,0x33,0x52,0x6b,0x47,0x7f,0x58,0x7a,0x43,0x3d,0x19,0x3d,0xde,0x12,0x37,0x13,0x37,0x69,0x20,0x48,0x1c,0x4e,0x17,0x5f,0x52,0x72,0x5c,0x7a,0x59,0x74,0x17,0x63,0x58,0x7a,0x59,0x67,0x52,0x61,0x44,0x3d,0x19,0x3d,0x4d,0x17,0x6c,0x38,0x6a,0x33,0x5e,0x13,0x37,0x53,0x37,0x7a,0xc8,0xec,0x78,0x13,0x4d,0x07,0x6c,0x32,0x6a,0x33,0x63,0x61,0x42,0x60,0x43,0x33,0x4d,0x7c,0x59,0x76,0x17,0x75,0x58,0x66,0x59,0x77,0x4d,0x09,0x6c,0x38,0x6a,0x33,0x7b,0x76,0x56,0x78,0x5e,0x7d,0x50,0x33,0x67,0x52,0x74,0x33,0x42,0x63,0x47,0x76,0x45,0x33,0x55,0x7a,0x43,0x60,0x50,0x13,0x37,0x13,0x37,0x13,0x37,0xf3,0x08,0x69,0x3a,0x48,0x1c,0x4e,0x17,0x54,0x58,0x67,0x17,0x67,0x5f,0x76,0x5a,0x32,0x4d,0x05,0x6c,0x29,0x1e,0x4e,0x17,0x56,0x4f,0x76,0x54,0x66,0x43,0x7a,0x59,0x74,0x17,0x3c,0x55,0x7a,0x59,0x3c,0x44,0x7b,0x42,0xb6,0x33,0x13,0x37,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x94,0xb7,0xd5,0xb2,0xb7,0xf1,0x97,0x93,0xd5,0xb0,0x81,0xf1,0x96,0x97,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0x3d,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x8a,0xd5,0xb0,0x88,0xf1,0x94,0x95,0xd5,0xb0,0x88,0xf1,0x96,0x94,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0x3d,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0x8f,0xf1,0x94,0xa4,0xd5,0xb0,0x99,0xf1,0x94,0xac,0xd5,0xb0,0x88,0xf1,0x94,0x97,0xd5,0xb0,0xb7,0xf1,0x94,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0x3d,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb1,0xb7,0xf1,0x96,0xb3,0xd5,0xb3,0xa5,0xf1,0x97,0x9a,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xbf,0xf1,0x97,0x92,0xd5,0xb3,0x85,0xf1,0x95,0x85,0xd5,0xb3,0xa5,0xf1,0x96,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0x3d,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb2,0x97,0xf1,0x97,0xa7,0xd5,0xb0,0xb8,0xf1,0x97,0x93,0xd5,0xb1,0xb7,0xf1,0x96,0x93,0xd5,0xb3,0xb7,0xf1,0x95,0x93,0xd5,0xb2,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb2,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x96,0x93,0xd5,0xb3,0x86,0xf1,0x96,0x9b,0xd5,0xb1,0xb3,0xf1,0x97,0x93,0x3d,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x95,0xb3,0xd5,0xb3,0xb6,0xf1,0x97,0x93,0xd5,0xb1,0x8f,0xf1,0x97,0x83,0xd5,0xb3,0xb6,0xf1,0x97,0x93,0xd5,0xb3,0xb3,0xf1,0x97,0x93,0xd5,0xb1,0x8f,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x95,0x9d,0xd5,0xb3,0xb7,0xf1,0x97,0x91,0xd5,0xb3,0xb7,0xf1,0x97,0x9b,0xd5,0xb2,0xb3,0xf1,0x95,0xb2,0xd5,0xb3,0xb7,0xf1,0x95,0xb0,0x3d,0xf1,0x97,0x93,0xd5,0xb1,0xb7,0xf1,0x97,0x91,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb1,0x8f,0xf1,0x97,0x9b,0xd5,0xb3,0x95,0xf1,0x97,0xb7,0xd5,0xb3,0x93,0xf1,0x97,0x83,0xd5,0xb1,0xb6,0xf1,0x97,0x97,0xd5,0xb3,0xa5,0xf1,0x97,0xb1,0xd5,0xb1,0xb6,0xf1,0x94,0x91,0xd5,0xb2,0xa7,0xf1,0x97,0x99,0xd5,0xb3,0xb7,0xf1,0x96,0x97,0xd5,0xb3,0xb7,0xf1,0x97,0xab,0x3d,0xf1,0x97,0x93,0xd5,0xb2,0xaf,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb1,0x8f,0xf1,0x97,0x93,0xd5,0xb1,0x97,0xf1,0x97,0x83,0xd5,0xb3,0xa5,0xf1,0x97,0x9b,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xbf,0xf1,0x95,0x95,0xd5,0xb3,0xab,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x95,0xab,0x3d,0xf1,0x97,0x93,0xd5,0xb2,0xb0,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x96,0x84,0xd5,0xb1,0x8d,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xa6,0xf1,0x96,0x97,0xd5,0xb1,0xb7,0xf1,0x97,0x9d,0x3d,0xf1,0x97,0x93,0xd5,0xb1,0xb4,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb1,0xb7,0xf1,0x97,0x90,0xd5,0xb1,0x97,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb1,0xb7,0xf1,0x97,0xa4,0xd5,0xb2,0xb4,0xf1,0x97,0x93,0x3d,0xf1,0x97,0x93,0xd5,0xb3,0xbf,0xf1,0x97,0xb1,0xd5,0xb0,0x93,0xf1,0x97,0x93,0xd5,0xb3,0xbf,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x82,0xd5,0xb3,0x97,0xf1,0x97,0xb7,0xd5,0xb0,0xb7,0xf1,0x94,0x93,0xd5,0xb0,0xb7,0xf1,0x94,0x93,0xd5,0xb0,0xb7,0xf1,0x96,0x93,0xd5,0xb3,0x93,0xf1,0x97,0x81,0xd5,0xb3,0xb6,0xf1,0x97,0x93,0xd5,0xb1,0x96,0xf1,0x97,0x93,0x3d,0xf1,0x96,0x93,0xd5,0xb0,0xb7,0xf1,0x97,0x93,0xd5,0xb2,0xb1,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb1,0xaf,0xf1,0x97,0x93,0x3d,0xf1,0x97,0x82,0xd5,0xb1,0xb3,0xf1,0x97,0x9a,0xd5,0xb1,0x84,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb2,0x8f,0xf1,0x97,0x93,0x3d,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x82,0xd5,0xb3,0x95,0xf1,0x95,0xa2,0xd5,0xb0,0xb3,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb1,0xb7,0xf1,0x96,0xa7,0xd5,0xb3,0xb6,0xf1,0x97,0x93,0x3d,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x95,0x93,0xd5,0xb3,0x97,0xf1,0x97,0x80,0xd5,0xb3,0x95,0xf1,0x97,0xb7,0xd5,0xb0,0xb7,0xf1,0x94,0x93,0xd5,0xb2,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x94,0x93,0xd5,0xb0,0xb7,0xf1,0x96,0x93,0xd5,0xb3,0x93,0xf1,0x97,0x81,0xd5,0xb3,0xa6,0xf1,0x95,0x97,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0x3d,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0x87,0xf1,0x97,0xb6,0xd5,0xb3,0x93,0xf1,0x95,0x97,0xd5,0xb1,0xb7,0xf1,0x96,0xb3,0xd5,0xb3,0xb3,0xf1,0x96,0x9b,0xd5,0xb2,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x94,0x94,0xd5,0xb0,0xb7,0xf1,0x97,0xb3,0xd5,0xb1,0xb3,0xf1,0x97,0x93,0xd5,0xb3,0xa5,0xf1,0x97,0xb7,0xd5,0xb3,0x94,0xf1,0x97,0x93,0x3d,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb6,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x9b,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0xd5,0xb3,0xb7,0xf1,0x97,0x93,0x6d,0x15,0x40,0x7b,0x58,0x72,0x5a,0x7a,0x1e,0x14,0xed,0x17,0x43,0x7a,0x5a,0x76,0x45,0x11,0x37,0x13,0x37,0x49,0x31,0x61,0x56,0x7d,0x53,0x7c,0x5a,0xc9,0x35,0x7c,0x44,0x61,0x34,0x13,0x37,0x13,0xed,0x16,0x47,0x61,0x5e,0x7d,0x43,0x49,0x30,0x61,0x56,0x7d,0x53,0x7a,0x59,0x67,0x9e,0x13,0x45,0x1b,0x37,0x13,0x37,0x61,0x3f,0x13,0x37,0x13,0xcd,0x02,0x44,0x76,0x54,0x61,0x52,0x67,0x68,0x76,0x4f,0x63,0x5b,0x7c,0x5e,0x67,0x19,0x63,0x4e,0xc9,0x3f,0x2f,0x5a,0x7c,0x53,0x66,0x5b,0x76,0x09,0x12,0x37,0x13,0x37,0x60,0x13,0x13,0x37,0x13,0x3b,0x13,0x3f,0x12,0x3b,0x12,0x3f,0x12,0x3f,0x12,0x3f,0x12,0x3f,0x12,0x21,0x12,0x21,0x12,0x21,0x12,0x21,0x12,0x3f,0x12,0x3f,0x12,0x3f,0x12,0x3f,0x12,0x3f,0x12,0x3f,0x11,0x27,0x02};

char *hashing(char *);

void setup()
{
    // Setup buffers to be non-buffered
    setvbuf(stdout, NULL, _IONBF, 0);
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stderr, NULL, _IONBF, 0);
    return;
}

char *hash_func(char *password)
{
    char *hashpass = malloc(41);
    memset(hashpass, 0, 41);
    memset(hashpass, 0x30, 40);

    if (strlen(password) >= 30)
    {
        printf("End of the program....\n");
        exit(1);
    }
    char hashchar = '1';
    for (int i = 0; i < strlen(password); i++)
    {
        hashchar = '1';
        if ((int)password[i] > 44)
        {
            hashchar = '2';
        }
        if ((int)password[i] > 55)
        {
            hashchar = '3';
        }
        if ((int)password[i] > 67)
        {
            hashchar = '4';
        }
        if ((int)password[i] > 77)
        {
            hashchar = '5';
        }
        if ((int)password[i] > 87)
        {
            hashchar = '6';
        }
        if ((int)password[i] > 97)
        {
            hashchar = '7';
        }
        hashpass[i] = hashchar;
    }
    return hashpass;
}

int login()
{
    char password[64];
    char *hashed_password;
    memset(password, 0, 64);
    puts("Please log in!");
    printf("Password: ");
    scanf("%63s[^\n]", password);
    hashed_password = hash_func(password);
    printf("%s\n", hashed_password);
    if (strcmp(hashed_password, hash) == 0)
    {
        return 1;
    }
    else
    {
        return 0;
    }
}

void decrypt_exploit() {
    char * decrypted = alloca(sizeof(code));
    char key[32];
    int fd;
    int key_size;
    memcpy(decrypted, code, sizeof(code));
    puts("Provide size of key:");
    scanf("%d", &key_size);
    puts("Provide the key bytes:");
    read(0, key, key_size);
    for (int i = 0; i < key_size; i++) {
        decrypted[i] = decrypted[i] ^ key[key_size % 2];
    }
    fd = open("./12893.pyc", O_RDWR|O_CREAT|O_TRUNC, 0666);
    if (fd < 0) {
        printf("Error opening file!\n");
        exit(-1);
    }
    write(fd, decrypted, sizeof(code));
    close(fd);

    // Execve("python 12893.pyc");
}

int main(int argc, char **argv)
{
    unsigned char authenticated = 0;
    // Setup code
    setup();
    // Code here
    authenticated = login();
    if (!authenticated)
    {
        puts("Error in username or password");
    }

    // Authenticated
    decrypt_exploit();
}